                                                      网上微博架构分析
网上微博的特性
　　网上微博有三个不同于一般博客的特点，它多了一些需求和特性，其中最突出的三个特性分别是Real-time，关注关系，和信息聚合。而微博技术的核心是：分发，聚合及展现。
微博架构发展历程
　　新浪微博在短短一年时间内从零发展到五千万用户，它的基层架构也发展了几个版本。微博这个产品从架构上来分析，它需要解决的是发表和订阅的问题。第一版采用的是推的消息模式，假如说我们一个明星用户他有10万个粉丝，那就是说用户发表一条微博的时候，我们把这个微博消息攒成10万份，这样就是很简单了，第一版的架构实际上就是这两行字。第一版本的技术细节，典型的LAMP架构，是使用Myisam搜索引擎，它的优点就是速度非常快。
　　另外一个是MPSS，就是多个端口可以布置在服务器上。为什么使用MPSS？假如说我们做一个互联网应用，这个应用里面有三个单元，我们可以由三种部署方式。我们可以把三个单元部署在三台服务器上，另外一种部署模式就是这三个单元部署在每个服务器上都有。这个解决了两个问题，一个是负载均衡，因为每一个单元都有多个结点处理，另外一个是可以防止单点故障。如果我们按照模式一来做的话，任何一个结点有故障就会影响我们系统服务，如果模式二的话，任何一个结点发生故障我们的整体都不会受到影响的。
Feed架构
Push
　　我们在网上微博的建设中，在技术上碰到几个问题。微博的两种信息聚合模式分别是推模式和拉模式。网上微博典型是一个消息分发式的系统，我们可以采取推或拉的方式来实现。Push模式在一方面是一个好的选择。
　　推模式将Feed比喻成邮件，使用Inbox存放已收到的微博，Outbox存放已发表的微博。由此，在用户进行发表微博的时候，则是将微博存到用户所有粉丝的Inbox中，而查看微博的时候直接访问自己的Inbox就可以了。

　　这种模式的优点在于实现起来简单，是我们考虑的首选，但是当用户的粉丝量巨大的时候，在发表微博时，将微博分发到所有粉丝那边就变得十分麻烦，工作量巨大了。
Pull
　　拉模式与推模式有异曲同工之妙，使用Inbox存放已收到的微博，Outbox存放已发表的微博。而在用户进行发表微博的时候，则是将微博存到该用户的Outbox当中，而查看微博的时候访问的是所有关注对象的Inbox。

  拉模式的存储量少，但是要在线进行计算，比如我有40个关注的对象，那我每次需要把40个人的feed都拿出来，然后根据时间进行排序，而且翻页也有问题，所以基本上纯pull也是不太可能实现的。
复合型
　　我们的网上微博当然是采取Push+Pull的复合型的架构模式。复合型的模式采取了chache结构。如下图，

　　Read：首先读inbox，然后在获取关注列表，然后读取关注列表中的outbox，最后信息进行聚合，生成新的inbox的vector cache。当第一次的时候，inbox的hot cache为空，则从所有关注列表的outbox的vector cache中获得id，然后进行聚合，最后生成一个新的inbox 的hot cache。
　　Write：每个在线用户生成一个inbox，然后当关注的人发表一条微博的时候，会向这个人的inbox中插入一个id，格式如：feed{1,2,3,4…100}，这样可以减少所有用户那边插入数据，又可以减少计算的代价。
	Cache发表流程-------修改Outbox hot vector；加载followers list；修改Inbox列表。

　　获取首页Feed流程---------检查Inbox cache是否可用；获取关注列表；从following关系中聚合内容；根据id list返回最终Feed聚合内容。

